<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA 球員卡訂購頁</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 UNICONS 圖標庫 -->
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">

    <!-- 引入 Swiper CSS，用於滑動效果 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css">

    <!-- 引入圖表 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <style>
        /*增加產品被選擇時的明顯狀態*/
        .prod-card.selectd {
            border-color: crimson;
            background-color: rgba(163, 163, 163, 0.85);
        }

        .prod-card {
            width: 18rem;
            margin: 0 auto;
        }

        .prod-card .card-img-top {
            height: 250px;
            object-fit: cover;
        }
        
        /* 付款方式樣式 */
        .payment-option {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .payment-option:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        
        .payment-option.selected {
            border-color: #28a745;
            background-color: #d4edda;
        }
        
        .payment-check {
            margin: 0;
        }
        
        .payment-label {
            width: 100%;
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }
        
        .form-check-input:checked ~ .payment-label {
            color: #28a745;
        }
        
        /* 付款欄位樣式 */
        .payment-fields {
            border-top: 1px solid #dee2e6;
            padding-top: 15px;
            margin-top: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
        }
        
        .payment-fields .form-control {
            border-radius: 5px;
            border: 1px solid #ced4da;
        }
        
        .payment-fields .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        /* 信用卡號格式化 */
        #cardNumber {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
        
        /* 動畫效果 */
        .payment-fields {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body>
    <form id="orderform" class="needs-validation" novalidate>
        <!--產品資訊區塊及頁面標題-->
        <section class="container mt-4">
            <h1 class="text-center">NBA 球員卡訂購頁</h1>

            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <strong>提醒：</strong> 請確認以下欄位是否正確。
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="關閉"></button>
            </div>
            <div class="card">
                <div class="card-header">
                    <h4>選擇產品</h4>
                </div>
                <div class="card-body">
                    <div class="row justify-content-center">
                        <!-- 產品1 -->
                        <div class="col-12 col-md-4 d-flex justify-content-center mb-4">
                            <div class="card prod-card border border-dark"
                                onclick="selectProduct(this, 'product1', 1100 )">
                                <img class="card-img-top" src="assets/curry.jpg" alt="Stephen Curry">
                                <div class="card-body">
                                    <!--產品標題-->
                                    <div class="d-flex justify-content-between align-items-center mt-1 mb-2">
                                        <h5 class="prod_title">Stephen Curry</h5>
                                        <span class="badge bg-danger">熱門</span>
                                    </div>
                                    <p class="card-text">NBA 球員卡</p>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>NT 1100</span>
                                        <div class="form-check">
                                            <input type="radio" class="form-check-input" id="product1" name="product"
                                                value="Stephen Curry">
                                            <label for="product1" class="form-check-label">選擇</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 產品2 -->
                        <div class="col-12 col-md-4 d-flex justify-content-center mb-4">
                            <div class="card prod-card border border-dark"
                                onclick="selectProduct(this, 'product2', 1000 )">
                                <img class="card-img-top" src="assets/durant.jpg" alt="Kevin Durant">
                                <div class="card-body">

                                    <!--產品標題-->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="prod_title">Kevin Durant</h5>
                                        <span class="badge bg-success">熱門</span>
                                    </div>
                                    <p class="card-text">NBA 球員卡</p>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>NT 1000</span>
                                        <div class="form-check">
                                            <input type="radio" class="form-check-input" id="product2" name="product"
                                                value="Kevin Durant">
                                            <label for="product2" class="form-check-label">選擇</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 產品3 -->
                        <div class="col-12 col-md-4 d-flex justify-content-center mb-4">
                            <div class="card prod-card border border-dark"
                                onclick="selectProduct(this, 'product3', 1200 )">
                                <img class="card-img-top" src="assets/lebron.jpg" alt="LeBron James">
                                <div class="card-body">
                                    <!--產品標題-->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="prod_title">LeBron James</h5>
                                        <span class="badge bg-warning">熱門</span>
                                    </div>
                                    <p class="card-text">NBA 球員卡</p>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>NT 1200</span>
                                        <div class="form-check">
                                            <input type="radio" class="form-check-input" id="product3" name="product"
                                                value="LeBron James">
                                            <label for="product3" class="form-check-label">選擇</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-check mt-1">
                        <input type="checkbox" class="form-check-input" id="warranty">
                        <label for="warranty" class="form-check-lable">添加延長保固服務(+NT $199)</label>
                    </div>
                </div>
            </div>

        </section>
        <!--消費者資訊-->
        <section class="container mt-4">
            <div class="row">
                <div class="col-12 col-md-6">
                    <div class="card">
                        <div class="card-header">客戶資訊</div>
                        <div class="card-body">
                            <div class="cname-div">
                                <label for="cname" class="form-check-label">購買人姓名</label>
                                <input id="cname" name="canme" class="form-control" required>
                                <div class="invalid-feedback">
                                    請輸入您的姓名
                                </div>
                            </div>
                            <div class="cemail-div mt-2">
                                <label for="cemail" class="form-check-label">購買人電郵</label>
                                <input id="cemail" name="cemail" class="form-control" required>
                                <div class="invalid-feedback">
                                    請輸入您的email
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="card">
                        <div class="card-header">配送資訊</div>
                        <div class="card-body">
                            <div class="city-div">
                                <!-- 縣市 -->
                                <label for="ccity" class="form-check-label">縣市</label>
                                <select class="form-select" id="ccity" name="ccity" required>
                                    <option value="">---請選擇---</option>
                                    <option value="台北市">台北市</option>
                                    <option value="新北市">新北市</option>
                                    <option value="桃園市">桃園市</option>
                                    <option value="台中市">台中市</option>
                                </select>
                                <div class="invalid-feedback">
                                    請輸入您的縣市
                                </div>
                            </div>
                            <div class="district-div mt-2">
                                <!-- 行政區域 -->
                                <label for="cdistrict" class="form-check-label">行政區域</label>
                                <input id="cdistrict" name="cdistrict" class="form-control" required>
                                <div class="invalid-feedback">
                                    請輸入您的行政區域
                                </div>
                            </div>
                            <div class="caddr-div mt-2">
                                <!-- 地址 -->
                                <label for="caddr" class="form-check-label">地址</label>
                                <input id="caddr" name="caddr" class="form-control" required>
                                <div class="invalid-feedback">
                                    請輸入您的地址
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!--付款方式-->
        <section class="container mt-4">
            <div class="card">
                <div class="card-header">支付方式</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <h5 class="mb-3">選擇付款方式</h5>
                            
                            <!-- 信用卡 -->
                            <div class="payment-option mb-3">
                                <div class="form-check payment-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="creditcard"
                                        value="creditcard" required>
                                    <label class="form-check-label payment-label" for="creditcard">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>💳 信用卡/Debit卡</strong>
                                                <div class="text-muted small">支援 Visa、MasterCard、JCB</div>
                                            </div>
                                            <span class="text-success small">推薦</span>
                                        </div>
                                    </label>
                                </div>
                                <!-- 信用卡輸入欄位 -->
                                <div id="creditcard-fields" class="payment-fields mt-3" style="display: none;">
                                    <!-- 測試卡號提示 -->
                                    <div class="alert alert-warning mb-3">
                                        <strong>🧪 測試環境</strong><br>
                                        <small>
                                            <strong>推薦測試卡號：</strong><br>
                                            Visa: <code>4311-9522-2222-2222</code><br>
                                            MasterCard: <code>5555-4444-3333-1111</code><br>
                                            有效期：<code>12/25</code> | CVV：<code>222</code> | 姓名：<code>TEST USER</code>
                                        </small>
                                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="fillTestCard()">
                                            快速填入測試資料
                                        </button>
                                    </div>
                                    <div class="row">
                                        <div class="col-12 mb-3">
                                            <label for="cardNumber" class="form-label">卡號</label>
                                            <input type="text" class="form-control" id="cardNumber" name="cardNumber" 
                                                   placeholder="1234 5678 9012 3456" maxlength="19">
                                            <div class="invalid-feedback">請輸入有效的信用卡號</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="expiryDate" class="form-label">有效期限</label>
                                            <input type="text" class="form-control" id="expiryDate" name="expiryDate" 
                                                   placeholder="MM/YY" maxlength="5">
                                            <div class="invalid-feedback">請輸入有效期限</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="cvv" class="form-label">安全碼 (CVV)</label>
                                            <input type="text" class="form-control" id="cvv" name="cvv" 
                                                   placeholder="123" maxlength="4">
                                            <div class="invalid-feedback">請輸入CVV</div>
                                        </div>
                                        <div class="col-12 mb-3">
                                            <label for="cardHolder" class="form-label">持卡人姓名</label>
                                            <input type="text" class="form-control" id="cardHolder" name="cardHolder" 
                                                   placeholder="JOHN DOE">
                                            <div class="invalid-feedback">請輸入持卡人姓名</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- LINE Pay -->
                            <div class="payment-option mb-3">
                                <div class="form-check payment-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="linepay" value="linepay">
                                    <label class="form-check-label payment-label" for="linepay">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>💚 LINE Pay</strong>
                                                <div class="text-muted small">使用 LINE Pay 快速付款</div>
                                            </div>
                                            <span class="text-primary small">便利</span>
                                        </div>
                                    </label>
                                </div>
                                <!-- LINE Pay 說明 -->
                                <div id="linepay-fields" class="payment-fields mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        點擊結帳後，您將被導向 LINE Pay 進行付款。請確保您的手機已安裝 LINE 應用程式。
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ATM 轉帳 -->
                            <div class="payment-option mb-3">
                                <div class="form-check payment-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="atm" value="atm">
                                    <label class="form-check-label payment-label" for="atm">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>🏧 ATM 轉帳</strong>
                                                <div class="text-muted small">手續費 +NT$20，3天內完成轉帳</div>
                                            </div>
                                            <span class="text-info small">+$20</span>
                                        </div>
                                    </label>
                                </div>
                                <!-- ATM 說明 -->
                                <div id="atm-fields" class="payment-fields mt-3" style="display: none;">
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        選擇ATM轉帳後，系統將提供虛擬帳號，請於3天內完成轉帳，逾期訂單將自動取消。
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 貨到付款 -->
                            <div class="payment-option mb-3">
                                <div class="form-check payment-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="cod">
                                    <label class="form-check-label payment-label" for="cod">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>📦 貨到付款</strong>
                                                <div class="text-muted small">收到商品時現金付款</div>
                                            </div>
                                            <span class="text-warning small">+$30</span>
                                        </div>
                                    </label>
                                </div>
                                <!-- 貨到付款說明 -->
                                <div id="cod-fields" class="payment-fields mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        選擇貨到付款，貨品送達時請準備現金給送貨員。需額外收取手續費 NT$30。
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="invalid-feedback">
                        請輸入您的支付方式
                    </div>
                </div>
            </div>
        </section>
        <!--訂單明細-->
        <section class="container mt-4">
            <div class="card">
                <div class="card-header">訂單摘要</div>
                <div class="card-body">
                    <div class="order-summary">
                        <div class="row mt-2">
                            <div class="col-7">產品</div>
                            <div class="col-5 text-end" id="productName">xyz</div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-7">價格</div>
                            <div class="col-5 text-end" id="productPrice">NT$0</div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-7">延長保固費用</div>
                            <div class="col-5 text-end" id="warrantyPrice">NT$0</div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-7">運費</div>
                            <div class="col-5 text-end" id="shippingPrice">NT$0</div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-7">付款手續費</div>
                            <div class="col-5 text-end">NT$0</div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-7">總計</div>
                            <div class="col-5 text-end" id="totalPrice">NT$0</div>
                        </div>
                    </div>
                    <div class="form-check mt-2">
                        <input type="checkbox" class="form-check-input" id="term" name="term" required>
                        <label for="term" class="form-check-label">
                            我已閱讀且同意<a href="javascript:;">服務條款</a>及<a href="javascript:;">隱私政策</a>
                        </label>
                        <div class="invalid-feedback">您必須同意才能進行結帳.</div>
                    </div>
                    <div class="mt-2 d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">結帳</button>
                    </div>
                </div>

            </div>
            </div>
        </section>

    </form>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        //全域變數
        let selectedProductPrice = 0;

        function selectProduct(cardEl, pid, price) {
            // 先還原每個產品卡片的選取狀態
            document.querySelectorAll('.prod-card').forEach(card => {
                card.classList.remove('selectd', 'border-success');
                card.classList.add('border-dark');
            });
            // 被選到的卡片加上綠色邊框
            cardEl.classList.add("selectd", "border-success");
            cardEl.classList.remove("border-dark");
            document.getElementById(pid).checked = true;
            document.getElementById("productName").textContent = document.getElementById(pid).value;
            document.getElementById("productPrice").textContent = `NTD$${price}`;
            selectedProductPrice = price;
            updateTotal();
        }
        //計算總金額
        function updateTotal() {
            let warranty = document.getElementById("warranty").checked; // 取得保固勾選狀態
            let warrantyPrice = warranty ? 199 : 0; // 保固金額

            let payment_fee = 0;
            let paymentMethod = document.querySelector("input[name=paymentMethod]:checked");
            if (paymentMethod) {
                if (paymentMethod.value == 'cod') {
                    payment_fee = 30;
                } else if (paymentMethod.value == 'atm') {
                    payment_fee = 20;
                }
            }

            document.getElementById("warrantyPrice").textContent = `NT$${warrantyPrice}`;
            document.getElementById("shippingPrice").textContent = `NT$${payment_fee}`;

            let totalPrice = selectedProductPrice + warrantyPrice + payment_fee;
            document.getElementById("totalPrice").textContent = `NT$${totalPrice}`;
        }

        document.querySelectorAll("input[name=paymentMethod]").forEach(obj => {
            obj.addEventListener("change", function() {
                // 更新總金額
                updateTotal();
                
                // 隱藏所有付款欄位
                document.querySelectorAll('.payment-fields').forEach(field => {
                    field.style.display = 'none';
                });
                
                // 移除所有信用卡欄位的必填驗證
                document.querySelectorAll('#creditcard-fields input').forEach(input => {
                    input.removeAttribute('required');
                });
                
                // 更新視覺效果
                document.querySelectorAll('.payment-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                if (this.checked) {
                    this.closest('.payment-option').classList.add('selected');
                    
                    // 根據選擇的付款方式顯示對應欄位
                    if (this.value === 'creditcard') {
                        document.getElementById('creditcard-fields').style.display = 'block';
                        // 為信用卡欄位添加必填驗證
                        document.querySelectorAll('#creditcard-fields input').forEach(input => {
                            input.setAttribute('required', 'required');
                        });
                    } else if (this.value === 'linepay') {
                        document.getElementById('linepay-fields').style.display = 'block';
                    } else if (this.value === 'atm') {
                        document.getElementById('atm-fields').style.display = 'block';
                    } else if (this.value === 'cod') {
                        document.getElementById('cod-fields').style.display = 'block';
                    }
                }
            });
        });
        
        // 為付款選項添加點擊事件
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function() {
                const radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change'));
                }
            });
        });
        
        document.getElementById("warranty").addEventListener("change", updateTotal);
        
        // 信用卡號格式化
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedInputValue = value.match(/.{1,4}/g)?.join(' ') || value;
            if (formattedInputValue.length <= 19) {
                e.target.value = formattedInputValue;
            }
        });
        
        // 有效期限格式化 (MM/YY)
        document.getElementById('expiryDate').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });
        
        // CVV 只允許數字
        document.getElementById('cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/gi, '');
        });
        
        // 持卡人姓名只允許英文字母和空格
        document.getElementById('cardHolder').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^a-zA-Z\s]/gi, '').toUpperCase();
        });
        
        // 快速填入測試資料
        function fillTestCard() {
            document.getElementById('cardNumber').value = '4311 9522 2222 2222';
            document.getElementById('expiryDate').value = '12/25';
            document.getElementById('cvv').value = '222';
            document.getElementById('cardHolder').value = 'TEST USER';
        }
        
        // 信用卡號驗證 (Luhn 算法 + 測試環境特殊處理)
        function validateCreditCard(number) {
            const cleanNumber = number.replace(/\s/g, '');
            if (cleanNumber.length < 13 || cleanNumber.length > 19) return false;
            
            // 綠界測試卡號白名單
            const testCards = [
                '4311952222222222', // Visa 測試卡
                '5555444433331111', // MasterCard 測試卡
                '3530111333300000', // JCB 測試卡
                '4000221111111111', // 失敗測試卡
                '4000000000000002', // 餘額不足測試卡
                '4000000000000069'  // 過期卡測試卡
            ];
            
            // 如果是測試卡號，直接通過驗證
            if (testCards.includes(cleanNumber)) {
                return true;
            }
            
            // 否則使用 Luhn 算法驗證
            let sum = 0;
            let isEven = false;
            
            for (let i = cleanNumber.length - 1; i >= 0; i--) {
                let digit = parseInt(cleanNumber[i]);
                
                if (isEven) {
                    digit *= 2;
                    if (digit > 9) digit -= 9;
                }
                
                sum += digit;
                isEven = !isEven;
            }
            
            return sum % 10 === 0;
        }
        
        // 有效期限驗證
        function validateExpiryDate(expiry) {
            const [month, year] = expiry.split('/');
            if (!month || !year) return false;
            
            const mon = parseInt(month);
            const yr = parseInt('20' + year);
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            
            if (mon < 1 || mon > 12) return false;
            if (yr < currentYear || (yr === currentYear && mon < currentMonth)) return false;
            
            return true;
        }
        
        // 綠界金流提交處理
        function submitToEcpay() {
            const form = document.getElementById('orderform');
            const formData = new FormData(form);
            
            // 取得所選產品資訊
            const selectedProduct = document.querySelector("input[name=product]:checked");
            if (!selectedProduct) {
                alert('請選擇產品');
                return false;
            }
            
            // 取得付款方式
            const paymentMethod = document.querySelector("input[name=paymentMethod]:checked");
            if (!paymentMethod) {
                alert('請選擇付款方式');
                return false;
            }
            
            // 如果選擇信用卡，驗證信用卡資料
            if (paymentMethod.value === 'creditcard') {
                const cardNumber = document.getElementById('cardNumber').value;
                const expiryDate = document.getElementById('expiryDate').value;
                const cvv = document.getElementById('cvv').value;
                const cardHolder = document.getElementById('cardHolder').value;
                
                // 驗證信用卡號
                if (!cardNumber || !validateCreditCard(cardNumber)) {
                    alert('請輸入有效的信用卡號');
                    document.getElementById('cardNumber').focus();
                    return false;
                }
                
                // 驗證有效期限
                if (!expiryDate || !validateExpiryDate(expiryDate)) {
                    alert('請輸入有效的有效期限');
                    document.getElementById('expiryDate').focus();
                    return false;
                }
                
                // 驗證CVV
                if (!cvv || cvv.length < 3) {
                    alert('請輸入有效的CVV安全碼');
                    document.getElementById('cvv').focus();
                    return false;
                }
                
                // 驗證持卡人姓名
                if (!cardHolder || cardHolder.trim().length < 2) {
                    alert('請輸入持卡人姓名');
                    document.getElementById('cardHolder').focus();
                    return false;
                }
            }
            
            // 準備送到後端的資料
            const orderData = {
                productName: selectedProduct.value,
                productPrice: selectedProductPrice,
                warranty: document.getElementById("warranty").checked,
                customerName: document.getElementById("cname").value,
                customerEmail: document.getElementById("cemail").value,
                city: document.getElementById("ccity").value,
                district: document.getElementById("cdistrict").value,
                address: document.getElementById("caddr").value,
                paymentMethod: paymentMethod.value
            };
            
            // 如果是信用卡付款，添加信用卡資訊
            if (paymentMethod.value === 'creditcard') {
                orderData.creditCard = {
                    cardNumber: document.getElementById('cardNumber').value.replace(/\s/g, ''),
                    expiryDate: document.getElementById('expiryDate').value,
                    cvv: document.getElementById('cvv').value,
                    cardHolder: document.getElementById('cardHolder').value
                };
            }
            
            // 除錯用：顯示即將發送的資料
            console.log('準備發送的訂單資料:', orderData);
            
            // 驗證必要欄位
            if (!orderData.productName || !orderData.productPrice || !orderData.customerName || !orderData.customerEmail) {
                alert('請填寫所有必要欄位');
                return false;
            }
            
            // 送到後端建立綠界訂單
            fetch('/api/create-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            })
            .then(response => {
                // 檢查回應狀態
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // 檢查 Content-Type 來判斷是 HTML 還是 JSON
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    // 如果是 JSON，表示有錯誤
                    return response.json().then(data => {
                        throw new Error(data.error || '訂單建立失敗');
                    });
                } else {
                    // 如果是 HTML，正常處理
                    return response.text();
                }
            })
            .then(html => {
                // 將綠界的表單插入頁面並自動提交
                document.body.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('訂單建立失敗：' + error.message);
            });
            
            return false;
        }

        // Example starter JavaScript for disabling form submissions if there are invalid fields
        (function () {
            'use strict'

            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            var forms = document.querySelectorAll('.needs-validation')

            // Loop over them and prevent submission
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        event.preventDefault(); // 阻止預設提交
                        
                        if (!form.checkValidity()) {
                            //如果表單透過html5原生驗証失敗的情況下
                            event.stopPropagation();
                        } else {
                            //如果表單透過html5原生驗証成功的情況下
                            // 呼叫綠界金流提交函數
                            submitToEcpay();
                        }

                        form.classList.add('was-validated')
                    }, false)
                })
        })()
    </script>
</body>

</html>